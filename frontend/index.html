<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot - Local RAG</title>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Syntax Highlighting for Code Blocks -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #212121;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
            color: #ececec;
        }

        .app-container {
            width: 100%;
            height: 100vh;
            background: #212121;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 260px;
            background: #171717;
            border-right: 1px solid #2f2f2f;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .sidebar-overlay.show {
            display: block;
            opacity: 1;
        }

        .sidebar-section {
            padding: 16px;
            border-bottom: 1px solid #2f2f2f;
        }

        .sidebar-section h3 {
            font-size: 12px;
            color: #8e8e8e;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .doc-count-badge {
            display: inline-block;
            background: #8e44ad;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 8px;
            font-weight: 600;
        }

        .btn {
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2a2a2a;
            color: #ececec;
            width: 100%;
            border: 1px solid #3f3f3f;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: #3a3a3a;
            border-color: #4f4f4f;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .conversation-item,
        .document-item {
            padding: 10px 12px;
            background: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            color: #b4b4b4;
        }

        .document-item.selected {
            border-color: #8e44ad;
            background: #2d2440;
        }

        .document-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            margin-top: 2px;
            accent-color: #8e44ad;
        }

        .document-info {
            flex: 1;
        }

        .conversation-item:hover,
        .document-item:hover {
            background: #3a3a3a;
        }

        .conversation-item.active {
            background: #3a3a3a;
            color: #ececec;
            border-color: #4f4f4f;
        }

        .conversation-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #ececec;
        }

        .conversation-meta {
            font-size: 11px;
            opacity: 0.6;
        }

        .document-name {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
            color: #ececec;
        }

        .document-meta {
            font-size: 11px;
            opacity: 0.6;
        }

        .delete-btn {
            float: right;
            background: #444;
            color: #ccc;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #ef4444;
            color: white;
        }

        /* MAIN CHAT AREA */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #212121;
        }

        .chat-header {
            background: #212121;
            color: #ececec;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #2f2f2f;
            position: relative;
            justify-content: center;
        }

        .header-left {
            position: absolute;
            left: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-center {
            flex: 0;
            text-align: center;
            max-width: 50%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-center h1 {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
            color: #ececec;
            white-space: nowrap;
        }

        .header-right {
            position: absolute;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hamburger-btn {
            background: none;
            border: none;
            color: #ececec;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border-radius: 6px;
        }

        .hamburger-btn:hover {
            background: #2a2a2a;
        }

        /* Model Selector - ChatGPT Style */
        .model-selector {
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .model-dropdown {
            padding: 8px 32px 8px 12px;
            background: transparent;
            color: #ececec;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            position: relative;
        }

        .model-dropdown:hover {
            background: #2a2a2a;
        }

        .model-dropdown option {
            background: #2a2a2a;
            color: #ececec;
            padding: 8px;
        }

        /* Custom dropdown arrow */
        .model-selector::after {
            content: "â–¼";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            color: #6e6e6e;
            pointer-events: none;
        }

        .header-spacer {
            flex: 1;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle-btn {
            background: #2a2a2a;
            border: 1px solid #3f3f3f;
            color: #ececec;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle-btn:hover {
            background: #3a3a3a;
        }

        /* Modern Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px;
            background: transparent;
            border-radius: 8px;
            border: none;
            transition: all 0.2s;
        }

        .toggle-container:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .toggle-switch {
            position: relative;
            width: 36px;
            height: 20px;
            background: #4a4a4a;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #10a37f;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(16px);
        }

        .toggle-label {
            font-size: 13px;
            color: #c5c5d0;
            font-weight: 400;
            user-select: none;
        }

        .upload-button-sidebar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 13px;
            background: #8e44ad;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            font-weight: 500;
            width: 100%;
        }

        .upload-button-sidebar:hover {
            background: #9b59b6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(142, 68, 173, 0.4);
        }

        .upload-button-sidebar:active {
            transform: scale(0.98);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 40px 20%;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: #212121;
            align-items: flex-start;
        }

        .chat-messages>* {
            max-width: 70%;
        }

        .message {
            max-width: 100%;
            padding: 16px 20px;
            border-radius: 0;
            margin-bottom: 0;
            line-height: 1.6;
            word-wrap: break-word;
            animation: fadeInUp 0.3s ease-out;
            font-size: 15px;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            align-self: flex-end;
            background: #2f2f2f;
            color: #ececec;
            text-align: left;
            padding: 10px 14px;
            border-radius: 18px;
            max-width: 70%;
            width: auto;
        }

        .bot-message {
            align-self: flex-start;
            background: transparent;
            color: #ececec;
            text-align: left;
            padding: 10px 0;
            border-radius: 0;
            max-width: 70%;
            width: auto;
        }

        /* Code Block Styling */
        .bot-message pre {
            background: #1a1a1a;
            border-radius: 6px;
            padding: 12px;
            overflow-x: auto;
            margin: 8px 0;
            border: 1px solid #3f3f3f;
        }

        .bot-message code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
        }

        .bot-message p code {
            background: #3a3a3a;
            color: #e06c75;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }

        .bot-message p {
            margin: 6px 0;
        }

        .bot-message ul,
        .bot-message ol {
            margin: 6px 0;
            padding-left: 20px;
        }

        .message-rag-badge {
            display: inline-block;
            background: #8e44ad;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 8px;
            font-weight: 600;
        }

        .loading {
            background: transparent;
            border: none;
            padding: 12px 0;
            border-radius: 0;
        }

        .loading-dots {
            display: flex;
            gap: 6px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background: #8e44ad;
            border-radius: 50%;
            animation: loading 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes loading {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        .chat-input-container {
            padding: 20px;
            background: #212121;
            border-top: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            justify-content: center;
        }

        .chat-input-wrapper {
            width: 100%;
            max-width: 700px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
        }

        .chat-input {
            padding: 14px 20px;
            border: 1px solid #3f3f3f;
            border-radius: 26px;
            font-size: 15px;
            outline: none;
            transition: all 0.2s;
            background: #2a2a2a;
            color: #ececec;
            width: 100%;
        }

        .chat-input::placeholder {
            color: #6e6e6e;
        }

        .chat-input:focus {
            border-color: #8e44ad;
            background: #2f2f2f;
        }

        .send-button {
            padding: 12px 24px;
            background: #8e44ad;
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-button:hover {
            background: #9b59b6;
            transform: translateY(-1px);
        }

        .send-button:active {
            transform: scale(0.98);
        }

        /* FILE UPLOAD */
        #fileInput {
            display: none;
        }

        .empty-state {
            text-align: center;
            color: #6e6e6e;
            padding: 16px;
            font-size: 13px;
        }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .hamburger-btn {
                display: flex;
            }

            .sidebar {
                position: fixed;
                left: -260px;
                top: 0;
                height: 100vh;
                z-index: 1000;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            }

            .sidebar.open {
                left: 0;
            }

            .chat-messages {
                padding: 20px 16px;
            }

            .message {
                font-size: 14px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #3f3f3f;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4f4f4f;
        }
    </style>
</head>

<body>
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div class="app-container">
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <!-- Chat History Section -->
            <div class="sidebar-section">
                <h3>Chat History<span class="doc-count-badge" id="chatCountBadge">0</span></h3>
                <button class="btn btn-primary" onclick="createNewConversation()">+ New Chat</button>
                <div id="conversationList" style="margin-top: 16px;">
                    <div class="empty-state">No conversations yet</div>
                </div>
            </div>

            <!-- Mini Documents Section -->
            <div class="sidebar-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0;">Documents <span class="doc-count-badge" id="docCountMini">0</span></h3>
                </div>
                <button class="upload-button-sidebar" onclick="document.getElementById('fileInput').click()">
                    ðŸ“„ Upload PDF
                </button>
                <input type="file" id="fileInput" accept=".pdf" onchange="uploadDocument(this.files[0])"
                    style="display: none;">
                <div id="documentListMini" style="margin-top: 16px; max-height: 300px; overflow-y: auto;">
                    <div class="empty-state">No documents yet</div>
                </div>
            </div>
        </div>

        <!-- MAIN CHAT AREA -->
        <div class="main-area">
            <div class="chat-header">
                <div class="header-left">
                    <button class="hamburger-btn" onclick="toggleSidebar()" title="Toggle Sidebar">
                        â˜°
                    </button>
                    <div class="model-selector">
                        <select id="modelDropdown" class="model-dropdown">
                            <option>Loading...</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div style="text-align: center; padding: 60px 20px; color: #ececec; max-width: 600px; margin: auto;">
                    <h2 style="font-size: 32px; margin-bottom: 16px; font-weight: 600; letter-spacing: -0.5px;">
                        Welcome!</h2>
                    <p style="font-size: 16px; color: #b4b4b4; line-height: 1.6;">Upload PDFs and ask questions about
                        them, or just chat normally.</p>
                </div>
            </div>

            <div class="chat-input-container">
                <!-- Use Documents Toggle -->
                <div class="toggle-container" style="justify-content: center; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="toggle-switch active" id="ragToggle" onclick="toggleRAG()">
                            <div class="toggle-slider"></div>
                        </div>
                        <span class="toggle-label">Use Documents</span>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="userInput" placeholder="Type your message..."
                        onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="send-button" id="sendButton" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'http://localhost:5000';
        let currentConversationId = null;
        let ragEnabled = true;
        let selectedDocuments = []; // Track selected documents for RAG

        // ==================== CONVERSATION MANAGEMENT ====================

        async function createNewConversation() {
            try {
                const response = await fetch(`${API_URL}/api/conversations/new`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: 'New Chat' })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    currentConversationId = data.conversation_id;
                    clearMessages();
                    loadConversations();
                    console.log('âœ… New conversation created:', currentConversationId);
                }
            } catch (error) {
                console.error('Error creating conversation:', error);
            }
        }

        async function loadConversations() {
            try {
                const response = await fetch(`${API_URL}/api/conversations`);
                const data = await response.json();
                if (data.status === 'success') {
                    displayConversations(data.conversations);
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        function displayConversations(conversations) {
            const list = document.getElementById('conversationList');

            // Update counter badge
            updateChatCount(conversations.length);

            if (conversations.length === 0) {
                list.innerHTML = '<div class="empty-state">No conversations yet</div>';
                return;
            }

            list.innerHTML = conversations.map(conv => `
                <div class="conversation-item ${conv.id === currentConversationId ? 'active' : ''}" onclick="loadConversation(${conv.id})">
                    <button class="delete-btn" onclick="deleteConversation(${conv.id}, event)">Ã—</button>
                    <div class="conversation-title">${conv.title}</div>
                    <div class="conversation-meta">${conv.message_count} messages</div>
                </div>
            `).join('');
        }

        async function loadConversation(convId) {
            try {
                const response = await fetch(`${API_URL}/api/conversations/${convId}`);
                const data = await response.json();
                if (data.status === 'success') {
                    currentConversationId = convId;
                    clearMessages();
                    data.conversation.messages.forEach(msg => {
                        addMessage(msg.content, msg.role === 'user' ? 'user' : 'bot', msg.has_rag_context);
                    });
                    loadConversations(); // Refresh list to update active state
                }
            } catch (error) {
                console.error('Error loading conversation:', error);
            }
        }

        async function deleteConversation(convId, event) {
            event.stopPropagation(); // Prevent loading the conversation when clicking delete

            if (!confirm('Delete this conversation? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/conversations/${convId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.status === 'success') {
                    // If we deleted the current conversation, clear the chat
                    if (convId === currentConversationId) {
                        currentConversationId = null;
                        clearMessages();
                        document.getElementById('chatMessages').innerHTML = `
                            <div style="text-align: center; padding: 60px 20px; color: #ececec; max-width: 600px; margin: auto;">
                                <h2 style="font-size: 32px; margin-bottom: 16px; font-weight: 600; letter-spacing: -0.5px;">Welcome!</h2>
                                <p style="font-size: 16px; color: #b4b4b4; line-height: 1.6;">Upload PDFs and ask questions about them, or just chat normally.</p>
                            </div>
                        `;
                    }

                    // Reload conversation list
                    loadConversations();
                    console.log('âœ… Conversation deleted');
                } else {
                    alert('Error deleting conversation: ' + data.message);
                }
            } catch (error) {
                console.error('Error deleting conversation:', error);
                alert('Error deleting conversation');
            }
        }

        // ==================== DOCUMENT MANAGEMENT ====================

        async function uploadDocument(file) {
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                console.log('ðŸ“¤ Uploading:', file.name);
                const response = await fetch(`${API_URL}/api/documents/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.status === 'success') {
                    console.log('âœ… Document uploaded:', data);
                    alert(`Document uploaded! ${data.pages} pages, ${data.chunks} chunks processed.`);
                    loadDocuments();
                } else {
                    alert('Error uploading document: ' + data.message);
                }
            } catch (error) {
                console.error('Error uploading document:', error);
                alert('Error uploading document');
            }
        }

        async function loadDocuments() {
            try {
                const response = await fetch(`${API_URL}/api/documents`);
                const data = await response.json();
                if (data.status === 'success') {
                    displayDocuments(data.documents);
                }
            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }

        function displayDocuments(documents) {
            const listMini = document.getElementById('documentListMini');

            // Update counter badges
            updateDocumentCount(documents.length);

            console.log(`ðŸ“š Displaying ${documents.length} documents:`);
            documents.forEach(doc => {
                console.log(`   ID: ${doc.id}, Filename: ${doc.filename}`);
            });

            const htmlContent = documents.length === 0
                ? '<div class="empty-state">No documents yet</div>'
                : documents.map(doc => `
                    <div class="document-item ${selectedDocuments.includes(doc.id) ? 'selected' : ''}" id="doc-${doc.id}">
                        <input type="checkbox" 
                               class="document-checkbox" 
                               id="checkbox-${doc.id}" 
                               ${selectedDocuments.includes(doc.id) ? 'checked' : ''}
                               onchange="toggleDocumentSelection(${doc.id})">
                        <div class="document-info">
                            <div class="document-name">ðŸ“„ ${doc.filename}</div>
                            <div class="document-meta">${doc.page_count} pages â€¢ ${(doc.file_size / 1024).toFixed(1)} KB</div>
                        </div>
                        <button class="delete-btn" onclick="deleteDocument(${doc.id}, event)">Ã—</button>
                    </div>
                `).join('');

            if (listMini) listMini.innerHTML = htmlContent;

            if (documents.length === 0) {
                selectedDocuments = [];
                return;
            }

            // Don't auto-select documents - let user choose
            console.log('ðŸ“„ Current selected documents:', selectedDocuments);
        }

        function toggleDocumentSelection(docId) {
            const checkbox = document.getElementById(`checkbox-${docId}`);
            const docItem = document.getElementById(`doc-${docId}`);

            console.log(`ðŸ” Toggle called for docId: ${docId}`);
            console.log(`   Checkbox checked state: ${checkbox.checked}`);
            console.log(`   Before: selectedDocuments = ${JSON.stringify(selectedDocuments)}`);

            // CORRECT LOGIC: checked = add, unchecked = remove
            if (checkbox.checked) {
                // Add to selected documents
                if (!selectedDocuments.includes(docId)) {
                    selectedDocuments.push(docId);
                    console.log(`   âœ… ADDED doc ${docId} to selection`);
                }
                docItem.classList.add('selected');
            } else {
                // Remove from selected documents
                selectedDocuments = selectedDocuments.filter(id => id !== docId);
                console.log(`   âŒ REMOVED doc ${docId} from selection`);
                docItem.classList.remove('selected');
            }

            console.log(`   After: selectedDocuments = ${JSON.stringify(selectedDocuments)}`);
        }

        async function deleteDocument(docId, event) {
            event.stopPropagation();
            if (!confirm('Delete this document?')) return;

            try {
                const response = await fetch(`${API_URL}/api/documents/${docId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.status === 'success') {
                    loadDocuments();
                }
            } catch (error) {
                console.error('Error deleting document:', error);
            }
        }

        // ==================== CHAT FUNCTIONS ====================

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            addMessage(message, 'user');
            showLoading();

            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: currentConversationId,
                        use_rag: ragEnabled,
                        selected_documents: selectedDocuments
                    })
                });

                const data = await response.json();
                hideLoading();

                if (data.response) {
                    currentConversationId = data.conversation_id;
                    // Add message with typing animation
                    addMessageWithTyping(data.response, 'bot', data.has_rag_context);
                    loadConversations(); // Refresh conversation list
                } else {
                    addMessage('Error: ' + (data.error || 'Unknown error'), 'bot');
                }
            } catch (error) {
                hideLoading();
                addMessage('âš ï¸ Cannot connect to backend. Make sure the server is running!', 'bot');
            }
        }

        function addMessage(text, sender, hasRag = false) {
            const messagesDiv = document.getElementById('chatMessages');
            // Remove welcome message if exists
            if (messagesDiv.children.length === 1 && messagesDiv.children[0].textContent.includes('Welcome')) {
                messagesDiv.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;

            // Use markdown parser for bot messages, plain text for user
            if (sender === 'bot') {
                messageDiv.innerHTML = marked.parse(text);
                // Apply syntax highlighting to code blocks
                messageDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            } else {
                messageDiv.textContent = text;
            }

            if (hasRag && sender === 'bot') {
                const badge = document.createElement('span');
                badge.className = 'message-rag-badge';
                badge.textContent = 'RAG';
                messageDiv.appendChild(badge);
            }

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addMessageWithTyping(text, sender, hasRag = false) {
            const messagesDiv = document.getElementById('chatMessages');

            // Remove welcome message if exists
            if (messagesDiv.children.length === 1 && messagesDiv.children[0].textContent.includes('Welcome')) {
                messagesDiv.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.style.opacity = '0';
            messagesDiv.appendChild(messageDiv);

            // Fade in the message box
            setTimeout(() => {
                messageDiv.style.transition = 'opacity 0.3s';
                messageDiv.style.opacity = '1';
            }, 10);

            // For bot messages, parse markdown first then animate
            if (sender === 'bot') {
                // Parse the full markdown
                const parsedHTML = marked.parse(text);

                // Create a temporary div to extract plain text for typing
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = parsedHTML;
                const plainText = tempDiv.textContent;

                // Typing animation - word by word
                const words = plainText.split(' ');
                let currentWordIndex = 0;
                let currentText = '';

                const typingInterval = setInterval(() => {
                    if (currentWordIndex < words.length) {
                        currentText += (currentWordIndex > 0 ? ' ' : '') + words[currentWordIndex];
                        messageDiv.textContent = currentText;
                        currentWordIndex++;

                        // Auto-scroll as text appears
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    } else {
                        clearInterval(typingInterval);

                        // Replace with formatted HTML after typing completes
                        messageDiv.innerHTML = parsedHTML;

                        // Apply syntax highlighting
                        messageDiv.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });

                        // Add RAG badge after typing completes
                        if (hasRag) {
                            const badge = document.createElement('span');
                            badge.className = 'message-rag-badge';
                            badge.textContent = 'RAG';
                            badge.style.opacity = '0';
                            messageDiv.appendChild(badge);

                            // Fade in the badge
                            setTimeout(() => {
                                badge.style.transition = 'opacity 0.3s';
                                badge.style.opacity = '1';
                            }, 100);
                        }
                    }
                }, 50); // Speed: 50ms per word (adjust for faster/slower)
            } else {
                // For user messages, keep existing plain text animation
                const words = text.split(' ');
                let currentWordIndex = 0;
                let currentText = '';

                const typingInterval = setInterval(() => {
                    if (currentWordIndex < words.length) {
                        currentText += (currentWordIndex > 0 ? ' ' : '') + words[currentWordIndex];
                        messageDiv.textContent = currentText;
                        currentWordIndex++;
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    } else {
                        clearInterval(typingInterval);
                    }
                }, 50);
            }
        }

        function showLoading() {
            const messagesDiv = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideLoading() {
            const loading = document.getElementById('loadingIndicator');
            if (loading) loading.remove();
        }

        function clearMessages() {
            document.getElementById('chatMessages').innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #ececec; max-width: 600px; margin: auto;">
                    <h2 style="font-size: 32px; margin-bottom: 16px; font-weight: 600; letter-spacing: -0.5px;">
                        Welcome!</h2>
                    <p style="font-size: 16px; color: #b4b4b4; line-height: 1.6;">Upload PDFs and ask questions about
                        them, or just chat normally.</p>
                </div>
            `;
        }

        function toggleRAG() {
            ragEnabled = document.getElementById('ragEnabled').checked;
            console.log('RAG', ragEnabled ? 'enabled' : 'disabled');
        }

        // ==================== MODEL MANAGEMENT ====================

        async function loadModels() {
            try {
                const response = await fetch(`${API_URL}/api/models`);
                const data = await response.json();
                if (data.status === 'success' && data.models) {
                    const dropdown = document.getElementById('modelDropdown');
                    dropdown.innerHTML = data.models.map(m =>
                        `<option value="${m.name}" ${m.name === data.current_model ? 'selected' : ''}>${m.name}</option>`
                    ).join('');
                }
            } catch (error) {
                console.error('Error loading models:', error);
            }

            // ==================== DOCUMENT SELECTION ====================

            function toggleDocumentSelection(docId) {
                const index = selectedDocuments.indexOf(docId);
                const docItem = document.getElementById(`doc-${docId}`);

                if (index > -1) {
                    // Deselect
                    selectedDocuments.splice(index, 1);
                    docItem.classList.remove('selected');
                } else {
                    // Select
                    selectedDocuments.push(docId);
                    docItem.classList.add('selected');
                }

                console.log('ðŸ“„ Selected documents:', selectedDocuments);
            }

            function getSelectedDocumentIds() {
                return selectedDocuments.length > 0 ? selectedDocuments : null;
            }
        }

        // ==================== THEME & SIDEBAR MANAGEMENT ====================

        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');

            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');

            // Update icon
            themeToggle.textContent = isDark ? '\u2600' : '\u263e';

            // Save preference
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');

            // Save preference
            const isOpen = sidebar.classList.contains('open');
            localStorage.setItem('sidebarOpen', isOpen);
        }

        function loadThemePreference() {
            const theme = localStorage.getItem('theme');
            const themeToggle = document.getElementById('themeToggle');

            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                if (themeToggle) themeToggle.textContent = '\u2600';
            }
        }

        function loadSidebarPreference() {
            const sidebarOpen = localStorage.getItem('sidebarOpen');

            if (sidebarOpen === 'true') {
                document.getElementById('sidebar').classList.add('open');
                document.getElementById('sidebarOverlay').classList.add('show');
            }
        }

        function updateDocumentCount(count) {
            // Update the mini docs box counter
            const miniCount = document.getElementById('docCountMini');
            if (miniCount) miniCount.textContent = count;

            // Update the small docs button
            const display = document.getElementById('docCountDisplay');
            if (display) display.textContent = count;
        }

        function updateChatCount(count) {
            const badge = document.getElementById('chatCountBadge');
            if (badge) badge.textContent = count;
        }

        // ==================== INITIALIZATION ====================


        // ==================== UI CONTROLS ====================

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function toggleRAG() {
            const toggle = document.getElementById('ragToggle');
            ragEnabled = !ragEnabled;

            if (ragEnabled) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }

            console.log('RAG', ragEnabled ? 'enabled' : 'disabled');
        }

        window.onload = function () {
            // Load data
            loadConversations();
            loadDocuments();
            loadModels();

            // Focus input
            document.getElementById('userInput').focus();
        };
    </script>
</body>

</html>