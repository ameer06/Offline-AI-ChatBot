<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot - Local RAG</title>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Syntax Highlighting for Code Blocks -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #d1fae5 0%, #10b981 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
            transition: background 0.3s ease;
        }

        /* Dark Mode Theme */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a1a 0%, #0a3d2e 100%);
        }

        body.dark-mode .app-container {
            background: rgba(30, 41, 59, 0.98);
        }

        .app-container {
            width: 100%;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 0;
            box-shadow: none;
            display: flex;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: fixed;
            left: -300px;
            top: 0;
            height: 100vh;
            transition: left 0.3s ease;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar.open {
            left: 0;
        }

        body.dark-mode .sidebar {
            background: #1f2937;
            border-right-color: #374151;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.show {
            display: block;
            opacity: 1;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        body.dark-mode .sidebar-section {
            border-bottom-color: #374151;
        }

        .sidebar-section h3 {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.dark-mode .sidebar-section h3 {
            color: #9ca3af;
        }

        .doc-count-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
            font-weight: 600;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .conversation-item,
        .document-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .document-item.selected {
            border-color: #10b981;
            background: #f0fdf4;
        }

        body.dark-mode .document-item.selected {
            background: #064e3b;
            border-color: #10b981;
        }

        .document-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-top: 2px;
            accent-color: #10b981;
        }

        .document-info {
            flex: 1;
        }

        body.dark-mode .conversation-item,
        body.dark-mode .document-item {
            background: #374151;
            border-color: #4b5563;
            color: #f3f4f6;
        }

        .conversation-item:hover,
        .document-item:hover {
            border-color: #10b981;
            transform: translateX(4px);
        }

        .conversation-item.active {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .document-size {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 4px;
        }

        .conversation-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-meta {
            font-size: 11px;
            opacity: 0.7;
        }

        .document-name {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .document-meta {
            font-size: 11px;
            opacity: 0.7;
        }

        .delete-btn {
            float: right;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 11px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        /* MAIN CHAT AREA */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .chat-header {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .hamburger-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            border-radius: 8px;
        }

        .hamburger-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .theme-toggle-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .chat-header h1 {
            font-size: 20px;
            font-weight: bold;
        }

        .chat-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .model-selector {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .model-selector-label {
            font-size: 14px;
            opacity: 1;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .model-dropdown {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.95);
            color: #059669;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            min-width: 150px;
        }

        .model-dropdown:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.2);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .model-dropdown option {
            color: #2d3748;
            padding: 8px;
        }

        .rag-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 14px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .rag-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .rag-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .upload-button {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.25);
            padding: 10px 18px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            font-weight: 600;
        }

        .upload-button:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
        }

        body.dark-mode .chat-messages {
            background: linear-gradient(to bottom, #1e293b 0%, #334155 100%);
        }

        .message {
            max-width: 75%;
            padding: 14px 18px;
            border-radius: 18px;
            line-height: 1.5;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            align-self: flex-end;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .bot-message {
            align-self: flex-start;
            background: white;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 4px;
        }

        body.dark-mode .bot-message {
            background: #475569;
            color: #f1f5f9;
            border-color: #64748b;
        }

        /* Code Block Styling */
        .bot-message pre {
            background: #282c34;
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            margin: 10px 0;
        }

        body.dark-mode .bot-message pre {
            background: #1e293b;
            border: 1px solid #475569;
        }

        .bot-message code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
        }

        .bot-message p code {
            background: #f1f5f9;
            color: #e53e3e;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }

        .bot-message p {
            margin: 8px 0;
        }

        .bot-message ul,
        .bot-message ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .message-rag-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 8px;
        }

        .loading {
            align-self: flex-start;
            background: white;
            border: 1px solid #e2e8f0;
            padding: 14px 18px;
            border-radius: 18px;
        }

        .loading-dots {
            display: flex;
            gap: 6px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: loading 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes loading {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        .chat-input-container {
            padding: 20px 25px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        body.dark-mode .chat-input-container {
            background: #334155;
            border-top-color: #475569;
        }

        .chat-input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 15px;
            outline: none;
            transition: all 0.3s;
            background: white;
            color: #2d3748;
        }

        body.dark-mode .chat-input {
            background: #475569;
            border-color: #64748b;
            color: #f1f5f9;
        }

        body.dark-mode .chat-input::placeholder {
            color: #cbd5e1;
        }

        .chat-input:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .send-button {
            padding: 14px 28px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        /* FILE UPLOAD */
        #fileInput {
            display: none;
        }

        .empty-state {
            text-align: center;
            color: #64748b;
            padding: 20px;
            font-size: 13px;
        }

        body.dark-mode .empty-state {
            color: #9ca3af;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div class="app-container">
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <!-- Chat History Section -->
            <div class="sidebar-section">
                <h3>üí¨ Chat History<span class="doc-count-badge" id="chatCountBadge">0</span></h3>
                <button class="btn btn-primary" onclick="createNewConversation()">+ New Chat</button>
                <div id="conversationList" style="margin-top: 16px;">
                    <div class="empty-state">No conversations yet</div>
                </div>
            </div>

            <!-- Documents Section -->
            <div class="sidebar-section">
                <h3>üìÑ Documents<span class="doc-count-badge" id="docCountBadge">0</span></h3>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">+ Upload
                    PDF</button>
                <input type="file" id="fileInput" accept=".pdf" onchange="uploadDocument(this.files[0])">
                <div id="documentList" style="margin-top: 16px;">
                    <div class="empty-state">No documents yet</div>
                </div>
            </div>
        </div>

        <!-- MAIN CHAT AREA -->
        <div class="main-area">
            <div class="chat-header">
                <button class="hamburger-btn" onclick="toggleSidebar()" title="Toggle Sidebar">
                    ‚ò∞
                </button>
                <div>
                    <div class="chat-header-icon" style="font-size: 28px; display: inline;">ü§ñ</div>
                </div>
                <div>
                    <h1>Local AI Chatbot with RAG</h1>
                    <p id="modelName">Powered by Ollama - 100% Offline</p>
                </div>
                <div class="model-selector">
                    <span class="model-selector-label">üéØ Model:</span>
                    <select id="modelDropdown" class="model-dropdown">
                        <option>Loading...</option>
                    </select>
                </div>
                <button class="upload-button" onclick="document.getElementById('fileInput').click()"
                    title="Upload PDF for RAG">
                    üì§ Upload PDF
                </button>
                <button class="theme-toggle-btn" onclick="toggleTheme()" id="themeToggle" title="Toggle Dark Mode">
                    üåô
                </button>
                <label class="rag-toggle">
                    <input type="checkbox" id="ragEnabled" checked onchange="toggleRAG()">
                    <span>üìÑ Use Documents</span>
                </label>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <h2
                        style="font-size: 28px; margin-bottom: 10px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        üëã Welcome!</h2>
                    <p>Upload PDFs and ask questions about them, or just chat normally.</p>
                </div>
            </div>

            <div class="chat-input-container">
                <input type="text" class="chat-input" id="userInput" placeholder="Type your message..."
                    onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="send-button" id="sendButton" onclick="sendMessage()">Send üöÄ</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'http://localhost:5000';
        let currentConversationId = null;
        let ragEnabled = true;
        let selectedDocuments = []; // Track selected documents for RAG

        // ==================== CONVERSATION MANAGEMENT ====================

        async function createNewConversation() {
            try {
                const response = await fetch(`${API_URL}/api/conversations/new`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: 'New Chat' })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    currentConversationId = data.conversation_id;
                    clearMessages();
                    loadConversations();
                    console.log('‚úÖ New conversation created:', currentConversationId);
                }
            } catch (error) {
                console.error('Error creating conversation:', error);
            }
        }

        async function loadConversations() {
            try {
                const response = await fetch(`${API_URL}/api/conversations`);
                const data = await response.json();
                if (data.status === 'success') {
                    displayConversations(data.conversations);
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        function displayConversations(conversations) {
            const list = document.getElementById('conversationList');

            // Update counter badge
            updateChatCount(conversations.length);

            if (conversations.length === 0) {
                list.innerHTML = '<div class="empty-state">No conversations yet</div>';
                return;
            }

            list.innerHTML = conversations.map(conv => `
                <div class="conversation-item ${conv.id === currentConversationId ? 'active' : ''}" onclick="loadConversation(${conv.id})">
                    <button class="delete-btn" onclick="deleteConversation(${conv.id}, event)">√ó</button>
                    <div class="conversation-title">${conv.title}</div>
                    <div class="conversation-meta">${conv.message_count} messages</div>
                </div>
            `).join('');
        }

        async function loadConversation(convId) {
            try {
                const response = await fetch(`${API_URL}/api/conversations/${convId}`);
                const data = await response.json();
                if (data.status === 'success') {
                    currentConversationId = convId;
                    clearMessages();
                    data.conversation.messages.forEach(msg => {
                        addMessage(msg.content, msg.role === 'user' ? 'user' : 'bot', msg.has_rag_context);
                    });
                    loadConversations(); // Refresh list to update active state
                }
            } catch (error) {
                console.error('Error loading conversation:', error);
            }
        }

        async function deleteConversation(convId, event) {
            event.stopPropagation(); // Prevent loading the conversation when clicking delete

            if (!confirm('Delete this conversation? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/conversations/${convId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.status === 'success') {
                    // If we deleted the current conversation, clear the chat
                    if (convId === currentConversationId) {
                        currentConversationId = null;
                        clearMessages();
                        document.getElementById('chatMessages').innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #64748b;">
                                <h2 style="font-size: 28px; margin-bottom: 10px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üëã Welcome!</h2>
                                <p>Upload PDFs and ask questions about them, or just chat normally.</p>
                            </div>
                        `;
                    }

                    // Reload conversation list
                    loadConversations();
                    console.log('‚úÖ Conversation deleted');
                } else {
                    alert('Error deleting conversation: ' + data.message);
                }
            } catch (error) {
                console.error('Error deleting conversation:', error);
                alert('Error deleting conversation');
            }
        }

        // ==================== DOCUMENT MANAGEMENT ====================

        async function uploadDocument(file) {
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                console.log('üì§ Uploading:', file.name);
                const response = await fetch(`${API_URL}/api/documents/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.status === 'success') {
                    console.log('‚úÖ Document uploaded:', data);
                    alert(`Document uploaded! ${data.pages} pages, ${data.chunks} chunks processed.`);
                    loadDocuments();
                } else {
                    alert('Error uploading document: ' + data.message);
                }
            } catch (error) {
                console.error('Error uploading document:', error);
                alert('Error uploading document');
            }
        }

        async function loadDocuments() {
            try {
                const response = await fetch(`${API_URL}/api/documents`);
                const data = await response.json();
                if (data.status === 'success') {
                    displayDocuments(data.documents);
                }
            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }

        function displayDocuments(documents) {
            const list = document.getElementById('documentList');

            // Update counter badge
            updateDocumentCount(documents.length);

            if (documents.length === 0) {
                list.innerHTML = '<div class="empty-state">No documents yet</div>';
                selectedDocuments = [];
                return;
            }

            // If no documents are selected yet, select all by default
            if (selectedDocuments.length === 0) {
                selectedDocuments = documents.map(doc => doc.id);
            }

            list.innerHTML = documents.map(doc => `
                <div class="document-item ${selectedDocuments.includes(doc.id) ? 'selected' : ''}" id="doc-${doc.id}">
                    <input type="checkbox" 
                           class="document-checkbox" 
                           id="checkbox-${doc.id}" 
                           ${selectedDocuments.includes(doc.id) ? 'checked' : ''}
                           onchange="toggleDocumentSelection(${doc.id})">
                    <div class="document-info">
                        <div class="document-name">üìÑ ${doc.filename}</div>
                        <div class="document-meta">${doc.page_count} pages ‚Ä¢ ${(doc.file_size / 1024).toFixed(1)} KB</div>
                    </div>
                    <button class="delete-btn" onclick="deleteDocument(${doc.id}, event)">√ó</button>
                </div>
            `).join('');

            console.log('üìÑ Selected documents:', selectedDocuments);
        }

        async function deleteDocument(docId, event) {
            event.stopPropagation();
            if (!confirm('Delete this document?')) return;

            try {
                const response = await fetch(`${API_URL}/api/documents/${docId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.status === 'success') {
                    loadDocuments();
                }
            } catch (error) {
                console.error('Error deleting document:', error);
            }
        }

        // ==================== CHAT FUNCTIONS ====================

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            addMessage(message, 'user');
            showLoading();

            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: currentConversationId,
                        use_rag: ragEnabled
                    })
                });

                const data = await response.json();
                hideLoading();

                if (data.response) {
                    currentConversationId = data.conversation_id;
                    // Add message with typing animation
                    addMessageWithTyping(data.response, 'bot', data.has_rag_context);
                    loadConversations(); // Refresh conversation list
                } else {
                    addMessage('Error: ' + (data.error || 'Unknown error'), 'bot');
                }
            } catch (error) {
                hideLoading();
                addMessage('‚ö†Ô∏è Cannot connect to backend. Make sure the server is running!', 'bot');
            }
        }

        function addMessage(text, sender, hasRag = false) {
            const messagesDiv = document.getElementById('chatMessages');
            // Remove welcome message if exists
            if (messagesDiv.children.length === 1 && messagesDiv.children[0].textContent.includes('Welcome')) {
                messagesDiv.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;

            // Use markdown parser for bot messages, plain text for user
            if (sender === 'bot') {
                messageDiv.innerHTML = marked.parse(text);
                // Apply syntax highlighting to code blocks
                messageDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            } else {
                messageDiv.textContent = text;
            }

            if (hasRag && sender === 'bot') {
                const badge = document.createElement('span');
                badge.className = 'message-rag-badge';
                badge.textContent = 'üìÑ RAG';
                messageDiv.appendChild(badge);
            }

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addMessageWithTyping(text, sender, hasRag = false) {
            const messagesDiv = document.getElementById('chatMessages');

            // Remove welcome message if exists
            if (messagesDiv.children.length === 1 && messagesDiv.children[0].textContent.includes('Welcome')) {
                messagesDiv.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.style.opacity = '0';
            messagesDiv.appendChild(messageDiv);

            // Fade in the message box
            setTimeout(() => {
                messageDiv.style.transition = 'opacity 0.3s';
                messageDiv.style.opacity = '1';
            }, 10);

            // For bot messages, parse markdown first then animate
            if (sender === 'bot') {
                // Parse the full markdown
                const parsedHTML = marked.parse(text);

                // Create a temporary div to extract plain text for typing
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = parsedHTML;
                const plainText = tempDiv.textContent;

                // Typing animation - word by word
                const words = plainText.split(' ');
                let currentWordIndex = 0;
                let currentText = '';

                const typingInterval = setInterval(() => {
                    if (currentWordIndex < words.length) {
                        currentText += (currentWordIndex > 0 ? ' ' : '') + words[currentWordIndex];
                        messageDiv.textContent = currentText;
                        currentWordIndex++;

                        // Auto-scroll as text appears
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    } else {
                        clearInterval(typingInterval);

                        // Replace with formatted HTML after typing completes
                        messageDiv.innerHTML = parsedHTML;

                        // Apply syntax highlighting
                        messageDiv.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });

                        // Add RAG badge after typing completes
                        if (hasRag) {
                            const badge = document.createElement('span');
                            badge.className = 'message-rag-badge';
                            badge.textContent = 'üìÑ RAG';
                            badge.style.opacity = '0';
                            messageDiv.appendChild(badge);

                            // Fade in the badge
                            setTimeout(() => {
                                badge.style.transition = 'opacity 0.3s';
                                badge.style.opacity = '1';
                            }, 100);
                        }
                    }
                }, 50); // Speed: 50ms per word (adjust for faster/slower)
            } else {
                // For user messages, keep existing plain text animation
                const words = text.split(' ');
                let currentWordIndex = 0;
                let currentText = '';

                const typingInterval = setInterval(() => {
                    if (currentWordIndex < words.length) {
                        currentText += (currentWordIndex > 0 ? ' ' : '') + words[currentWordIndex];
                        messageDiv.textContent = currentText;
                        currentWordIndex++;
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    } else {
                        clearInterval(typingInterval);
                    }
                }, 50);
            }
        }

        function showLoading() {
            const messagesDiv = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideLoading() {
            const loading = document.getElementById('loadingIndicator');
            if (loading) loading.remove();
        }

        function clearMessages() {
            document.getElementById('chatMessages').innerHTML = '';
        }

        function toggleRAG() {
            ragEnabled = document.getElementById('ragEnabled').checked;
            console.log('RAG', ragEnabled ? 'enabled' : 'disabled');
        }

        // ==================== MODEL MANAGEMENT ====================

        async function loadModels() {
            try {
                const response = await fetch(`${API_URL}/api/models`);
                const data = await response.json();
                if (data.status === 'success' && data.models) {
                    const dropdown = document.getElementById('modelDropdown');
                    dropdown.innerHTML = data.models.map(m =>
                        `<option value="${m.name}" ${m.name === data.current_model ? 'selected' : ''}>${m.name}</option>`
                    ).join('');
                }
            } catch (error) {
                console.error('Error loading models:', error);
            }

            // ==================== DOCUMENT SELECTION ====================

            function toggleDocumentSelection(docId) {
                const index = selectedDocuments.indexOf(docId);
                const docItem = document.getElementById(`doc-${docId}`);

                if (index > -1) {
                    // Deselect
                    selectedDocuments.splice(index, 1);
                    docItem.classList.remove('selected');
                } else {
                    // Select
                    selectedDocuments.push(docId);
                    docItem.classList.add('selected');
                }

                console.log('üìÑ Selected documents:', selectedDocuments);
            }

            function getSelectedDocumentIds() {
                return selectedDocuments.length > 0 ? selectedDocuments : null;
            }
        }

        // ==================== THEME & SIDEBAR MANAGEMENT ====================

        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');

            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');

            // Update icon
            themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';

            // Save preference
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');

            // Save preference
            const isOpen = sidebar.classList.contains('open');
            localStorage.setItem('sidebarOpen', isOpen);
        }

        function loadThemePreference() {
            const theme = localStorage.getItem('theme');
            const themeToggle = document.getElementById('themeToggle');

            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                if (themeToggle) themeToggle.textContent = '‚òÄÔ∏è';
            }
        }

        function loadSidebarPreference() {
            const sidebarOpen = localStorage.getItem('sidebarOpen');

            if (sidebarOpen === 'true') {
                document.getElementById('sidebar').classList.add('open');
                document.getElementById('sidebarOverlay').classList.add('show');
            }
        }

        function updateDocumentCount(count) {
            const badge = document.getElementById('docCountBadge');
            if (badge) badge.textContent = count;
        }

        function updateChatCount(count) {
            const badge = document.getElementById('chatCountBadge');
            if (badge) badge.textContent = count;
        }

        // ==================== INITIALIZATION ====================

        window.onload = function () {
            // Load user preferences
            loadThemePreference();
            loadSidebarPreference();

            // Load data
            loadConversations();
            loadDocuments();
            loadModels();

            // Focus input
            document.getElementById('userInput').focus();
        };
    </script>
</body>

</html>